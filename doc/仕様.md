# 仕様
- [SIP関連RFC和訳 | 技術ライブラリ | テクノロジー | SOFTFRONT](http://www.softfront.co.jp/technology-library-rfc/)
  - [RFC 3261 - SIP(セッション開始プロトコル)](http://www.softfront.co.jp/tech/ietfdoc/trans/rfc3261j.txt)
  - [RFC 3261 - SIP: Session Initiation Protocol](https://tools.ietf.org/html/rfc3261)
- [Digest認証 - Wikipedia](https://ja.wikipedia.org/wiki/Digest%E8%AA%8D%E8%A8%BC)
  - [RFC 7616 - HTTP Digest Access Authentication](https://tools.ietf.org/html/rfc7616)

# RFC 3261 - SIP(セッション開始プロトコル)
## 8 ユーザーエージェントの一般的な動作
- 8.1 UACの動作
  - 8.1.1 リクエストの生成
    - 8.1.1.1 Request-URI
      - [x] メッセージの最初のRequest-URIには、ToフィールドのURIの値が設定されるべきである[SHOULD]。
        - ~~注目に値する一つの例外は、REGISTERメソッドである。REGISTERのRequest-URIを設定する動作はセクション10で与えられる。これらのフィールドに同じ値を設定することは、プライバシーのためあるいは利便性のために望ましくないかもしれない(特に発信元のUAがRequest-URIが運搬中に変更されることを期待する場合)。~~
      - ~~ある特別な状況下では、既存のルートセットがメッセージのRequest-URIに影響を及ぼすことがある。既存のルートセットとは、UACが外に向けて送り出すダイアログ外リクエストの宛先となる、一連のサーバーを特定する順番に並べられたURIセットである。一般に、それらはUA上でユーザーまたはサービスプロバイダによって、マニュアルあるいは他の非SIPの仕組みで設定される。プロバイダがUAに アウトバウンドプロキシを設定することを望む場合、それに一つのURI(アウトバウンドプロキシのもの)を持つ既存のルートセットを提供することで、それを行うことが推奨される[RECOMMENDED]。~~
        - ルートセットはサポートしない。
      - ~~既存のルートセットが存在する場合、(たとえダイアログがなくても、)リモートのターゲットURIとして望ましいRequest-URIを使用して、セクション12.2.1.1に詳述されているRequest-URIとRouteヘッダーフィールドを組み込むための手順に従わなければならない[MUST]。~~
        - ルートセットはサポートしない。
    - 8.1.1.2 To
      - Toヘッダーフィールドは、まず、希望するリクエストの「論理的」な受信者、またはこのリクエストのターゲットであるユーザーあるいはリソースのAddress-of-Recordを指定する。これは、リクエストの最終的な受信者であるかもしれないし、そうでないかもしれない。
      - ~~ToヘッダーフィールドはSIP URIまたはSIPS URIを含めてもよい[MAY]が、妥当なときには、その他のURIスキーム(例えば、tel URL(RFC2806 参考文献[9]))を使用することもできる。~~
        - SIP URIのみサポートする。
      - [ ] すべてのSIP実装はSIP URIスキームをサポートしなければならない[MUST]。
      - ~~TLSをサポートするいかなる実装も、SIPS URIスキームをサポートしなければならない[MUST]。~~
        - TLSをサポートしない。
      - Toヘッダーフィールドは、表示名を考慮に入れている。
      - UACは、ある特定のリクエストのためのToヘッダーフィールドをどのように組み込むか、様々な方法で知ることができる。
        - 通常、ユーザーがヒューマンインターフェースを介して(おそらく、URIをマニュアルで入力するか、ある種のアドレス帳から選択して)、Toヘッダーフィールドを提示する。
        - 高い頻度で、ユーザーは完全なURIではなく数字や文字の列を入力するだろう(例えば、「bob」)。この入力をどのように解釈するかはUAの判断による。
          - その文字列をSIP URIのユーザー部分を形成するために使用するということは、UAが名前をドメイン内で解決してSIP URIのアットマークの右側を得ることを望むことを暗に示す(例えば、sip:bob@example.com)。
          - その文字列をSIPS URIのユーザー部分を形成するために使用するということは、UAが、通信を安全に行い、名前がドメイン内で解決されてアットマークの右側が得られることを望むことを暗に示す。
      - アットマークの右側は高い頻度でリクエスト送信者のホームドメインであるだろう。このことは、そのホームドメインが外に送られるリクエストを処理することを認める。これは、ホームドメイン内でユーザー部分の解釈が求められる、「スピードダイヤル」のような機能に対して有用である。
      - ユーザーによって入力された電話番号を解釈すべきドメインを指定することをUAが望まないとき、tel URLが使用されるかもしれない。そうすることで、リクエストが通過する各ドメインがその機会を与えられる。
        - 例えば、空港にいるユーザーは、空港のアウトバウンドプロキシにログインして、それを通してリクエストを送るかもしれない。そのユーザーが「411」(これはアメリカのローカル電話番号案内の番号である)を入力する場合、それは、ユーザーのホームドメインではなく、空港のアウトバウンドプロキシによって解釈され処理される必要がある。この場合、「tel:411」が正しい選択である。
      - [x] ダイアログ外のリクエストは、To tagを含んではならない[MUST NOT] (リクエストのToフィールドのtagは、ダイアログの相手を特定する)。ダイアログが確立されていないので、tagは存在しない。
        - REGISTERのリクエストは、Toタグを含んでいない。
    - 8.1.1.3 From
      - Fromヘッダーフィールドは、リクエストを開始した者の論理的なアイデンティティを示す。これはおそらく、ユーザーのAddress-of-Recordであろう。
      - [ ] Toヘッダーフィールドと同じように、URIおよびオプションとして表示名を含む。
      - それは、リクエストに適用するための処理ルールを決定するために、SIPエレメントによって使用される(例えば、自動通話拒否)。
      - [ ] このような場合、IPアドレスやホストのFQDNは論理的な名前ではないので、FromのURIがこれらを含まないことが非常に重要である。
        - DNSサーバを運用開始するまでは、IPアドレスで妥協する (TODO)
      - Fromヘッダーフィールドは表示名を考慮している。クライアントのアイデンティティを隠したままにする場合、UACは「Anonymous」という表示名を、構文的に正しいが意味を持たない(sip:thisis@anonymous.invalidのような)URIと共に使用するべきである[SHOULD]。
      - 通常、ある特定のUAによって生成されたリクエスト中のFromヘッダーフィールドに存在する値は、ユーザーあるいはユーザーのローカルドメインの管理者によって、あらかじめ用意されている。
      - ある特定のUAが複数のユーザーに使用される場合、それは、ユーザーのアイデンティティに対応したURIを含む、切り替え可能なプロファイルを持っているかもしれない。
      - リクエストの受信者は、リクエストの発信元がそのFromヘッダーフィールドが主張している者であるということを確実にするために、リクエストの発信元を認証できる(認証について詳しくは、セクション22参照のこと)。
      - [x] Fromフィールドは、UACが選んだ新しいtagを含まなければならない[MUST]。
        - Call-IDと同様に、ランダム英数字36文字とする
    - 8.1.1.4 Call-ID
      - [ ] Call-IDヘッダーフィールドは、連続するメッセージをグループ化するための一意の識別子として作用する。それは、ダイアログ中のどのUAが送ったものであれ、すべてのリクエストおよび応答において同じ値でなければならない[MUST]。
      - [x] それは、UAからの各登録においても同じ値であるべきである[SHOULD]。
        - 初回登録時に、1度だけCall-IDを生成する。
      - [x] すべてのダイアログの外部にあるUACによって生成された新規リクエストでは、Call-IDヘッダーフィールドは、メソッド特有の動作でオーバーライドされなければ、あらゆる時と場所においてグローバルに一意な値となるよう、UACが選択しなければならない[MUST]。
        - サンプルに則って、ランダム英数字36文字＋ホスト名とする
        - ドメインに対応することで、ユニーク度を高めることができる (TODO)
      - [x] Call-IDの生成において、暗号的にランダムな識別子(RFC1750 参考文献[12])の使用が推奨される[RECOMMENDED]。
        - [RFC1750 セキュリティのためのランダムさの推薦](http://www5d.biglobe.ne.jp/stssk/rfc/rfc1750j.html)
        - サンプルに則って、ランダム英数字36文字＋ホスト名とする
      - [x] 実装では、「localid@host」形式を使用してもよい[MAY]。
        - サンプルに則って、ランダム英数字36文字＋ホスト名とする
      - [ ] Call-IDは、大文字小文字を区別し、単純に各バイトごとに比較される。
        - Call-IDの一致比較をする際に、加工しない
    - 8.1.1.5 CSeq
      - CSeqヘッダーフィールドは、トランザクションを識別し順番付けするための手段としての役目を果たす。
      - [x] CSeqは、シーケンス番号とメソッドから成る。
      - [x] メソッドは、リクエストのメソッドとマッチしなければならない[MUST]。
      - ダイアログ外の非REGISTERリクエストでは、シーケンス番号値は任意である。
        - ダイアログ外の非REGISTERリクエストとは、具体的に何か (TODO)
      - [ ] シーケンス番号値は、32ビットの符号なし整数で表現可能でなければならず[MUST]、
      - [ ] また、2**31未満でなければならない[MUST]。
      - 上記のガイドラインに従う限り、クライアントはCSeqヘッダーフィールド値を選択するために、それが望むいかなる仕組みにおいても使用できる。
    - 8.1.1.7 Via
      - [ ] UACがリクエストを生成するとき、それはそのリクエストにViaを挿入しなければならない[MUST]。
      - [ ] ヘッダーフィールド中のプロトコル名とプロトコルバージョンは、それぞれSIPおよび2.0でなければならない[MUST]。
      - [ ] Viaヘッダーフィールド値はbranchパラメータを含まなければならない[MUST]。
      - [ ] branchパラメータ値は、そのUAによって送られるすべてのリクエストに対して、あらゆる時と場所を通して一意でなければならない[MUST]。
        - このルールの例外は、CANCELと非2xx応答に対するACKである。
      - [ ] この仕様に準拠するエレメントによって挿入されたbranch IDは、常に文字列「z9hG4bK」から始まらなければならない[MUST]。
      - branchトークンの細かい書式は実装が決める。
        - RFCの常だけど、投げっぱなしにもほどがある。
      - Viaヘッダーのmaddr、ttl、およびsent-byコンポーネントは、リクエストがトランスポートレイヤーで処理されるときに設定される(セクション18参照)。
      - プロキシのVia処理については、セクション16.6の項目8およびセクション16.7の項目3で述べられている。
## 10 登録
- 10.1 概要
  - ~~あるドメインのための登録サーバーはロケーションサービスへのデータを読み書きできなければならず[MUST]、~~
    - クライアントでは考慮しない。
  - ~~そのドメインのためのプロキシまたはリダイレクトサーバーはそのデータを読むことができなければならない[MUST]ということである。~~
    - クライアントでは考慮しない。
  - ~~登録サーバーは、同じドメインのための特定のSIPプロキシサーバーと同じ場所に配置してもよい[MAY]。~~
    - クライアントでは考慮しない。
- 10.2 REGISTERリクエストの構築
  - ~~UACはREGISTERリクエストに、セクション8.1で述べられている既存のルートセットに基づくRouteヘッダーフィールドを含めてもよい[MAY]。~~
    - ルートセットに対応しない。
  - ~~Record-RouteヘッダーフィールドはREGISTERリクエストまたは応答において何ら意味を持たず、存在した場合には無視されなければならない[MUST]。~~
    - ルートセットに対応しない。
  - ~~特に、UACはREGISTERリクエストに対するいかなる応答中のRecord-Routeヘッダーフィールドの存在/不在に基づいても、新しいルートセットを生成してはならない[MUST NOT]。~~
    - ルートセットに対応しない。
  - [ ] 以下のヘッダーフィールドは、Contactを除いて、REGISTERリクエストに含めなければならない[MUST]。Contactヘッダーフィールドは含めてもよい[MAY]。
    - [x] Request-URI: Request-URIは、登録が行われるロケーションサービスのドメインを示す(例: sip:chicago.com)。SIP URIのuserinfoと@コンポーネントが存在してはならない[MUST NOT]。
    - [x] To: Toヘッダーフィールドは、登録が生成、問い合わせ、あるいは修正されるAdress-of-Recordを含む。ToヘッダーフィールドとRequest-URIフィールドは、前者がユーザーネームを含むので通常は異なる。このAddress-of-RecordはSIP URIまたはSIPS URIでなければならない[MUST]。
    - [x] From: Fromヘッダーフィールドは、登録を行う人のAddress-of-Recordを含む。リクエストがサードパーティによる登録でなければ、この値はToヘッダーフィールドと同じである。
    - [x] Call-ID: UACからのすべての登録は、特定の登録サーバーに送られる登録に対して、同じCall-IDヘッダーフィールド値を使用するべきである[SHOULD]。同一のクライアントが異なるCall-ID値を使用した場合、登録サーバーは、遅延したREGISTERリクエストが順番が狂って到着したのか、あるいはそうでないのか検知できない。
      - 初回登録時に、1度だけCall-IDを生成する。
    - [x] CSeq: CSeq値はREGISTERリクエストの適切な並び順を保証する。UAは、同じCall-IDを持つ各REGISTERリクエストに対してCSeq値を1ずつインクリメントしなければならない[MUST]。
      - 1から開始し、都度1ずつインクリメントする
    - [ ] Contact: REGISTERリクエストは、アドレスバインディングを含むゼロ個以上の値を持つContactヘッダーフィールドを含めてもよい[MAY]。
      - Contactヘッダーフィールドを付加する。
  - [ ] UAは、登録サーバーから以前に送った登録への最終応答を受け取るか、以前のREGISTERリクエストがタイムアウトするまで、新たな登録(すなわち、再送とは違い新しいContactヘッダーフィールド値を含む)を送ってはならない[MUST NOT]。
    - (TODO)
  - [x] 以下のContactヘッダーパラメータはREGISTERリクエストにおいて特別な意味を持つ。
    - action: 
      - ~~RFC2543からのactionパラメータは反対されている。UACはactionパラメータを使用するべきではない[SHOULD NOT]。~~
        - actionパラメータは使用しない。
    - expires:
      - ~~expiresパラメータは、どれだけの期間バインディングが有効であってほしいとUAが望むかを示す。値は秒を表す数字である。~~
      - ~~このパラメータが提供されない場合、Expiresヘッダーフィールドの値が代わりに使用される。~~
      - ~~実装では、2* *32-1(4294967295秒または136年)よりも大きい値を2**32-1と等しい値として扱ってもよい[MAY]。~~
      - ~~おかしな値は3600と等しい値として扱うべきである[SHOULD]。~~
      - Expiresヘッダフィールドを付加する。expiresパラメータは付加しない。
  - 10.2.1 バインディングの追加
    - [ ] 登録サーバーに送られたREGISTERリクエストはAddress-of-Recordに対するSIPリクエストが転送(forward)されるべき[SHOULD]コンタクトアドレス(一つ~~または複数~~)を含む。Address-of-Recordは、REGISTERリクエストのToヘッダーフィールドに含まれる。
      - Contactヘッダフィールドを付加する。複数のバインディングに対応しない。
    - [ ] リクエストのContactヘッダーフィールド値は一般的に特定のSIPエンドポイントを特定するSIP URIまたはSIPS URIからなるが、どのようなURIスキームでも使用してもよい[MAY]。
      - SIP URIとする。
    - [ ] クライアントがいったん登録サーバーでバインディングを確立すると、それは必要に応じて、既存のバインディングに対する新しいバインディングまたは修正を含む登録を送ってもよい[MAY]。
      - 更新機能を実装する。
    - ~~REGISTERリクエストのToヘッダーフィールドのAddress-of-RecordがSIPS URIの場合、そのリクエストのすべてのContactヘッダーフィールド値もSIPS URIであるべきである[SHOULD]。~~
      - SIPS URIをサポートしない。
    - 10.2.1.1 Contactアドレスの有効期限間隔の設定
      - [ ] クライアントがREGISTERリクエストを送るとき、クライアントはどれだけのあいだ登録が有効であってほしいと望むかを示す有効期限間隔を提案してもよい[MAY]。REGISTERに、提案される有効期限時間を表現するいずれの仕組みも存在しない場合、クライアントはサーパーに選択させるという要望を示している。
        - Expiresヘッダフィールドを付加する。
    - 10.2.1.2 Contactアドレス間のプリファレンス
      - REGISTERリクエストで二つ以上のContactが送られる場合、登録を行うUAはこれらのContactヘッダーフィールド値の中のすべてのURIをToフィールドに存在するaddress-of-recordに関連付けることを意図している。
  - 10.2.2 バインディングの削除
    - [ ] 登録はソフトステートであり、リフレッシュされなければ期限切れになるが、明示的に削除することもできる。UAはREGISTERリクエスト中のコンタクトアドレスに0という有効期限間隔を指定することで、バインディングの即時削除を要求する。バインディングがその有効期限間隔が経過する前に削除されることが可能なように、UA はこの仕組みをサポートするべきである[SHOULD]。
    - ~~REGISTER固有のContactヘッダーフィールド値である「*」は、すべての登録に適用されるが、Expiresヘッダーが0という値で存在しなければ使用してはならない[MUST NOT]。~~
      - 複数のバインディングに対応しない。
  - 10.2.3 バインディングの取得
    - REGISTERリクエストに対する成功応答は、リクエストがContactヘッダーフィールドを含んでいたかどうかに関わらず、既存のバインディングの完全なリストを含む。REGISTERリクエストに Contactヘッダーフィールドが存在しなかった場合、バインディングのリストは変更されない。
  - 10.2.4 バインディングのリフレッシュ
    - [ ] それぞれのUAは、それが以前に確立したバインディングをリフレッシュする責任を負う。UAは、他のUAによってセットアップされたバインディングをリフレッシュするべきではない[SHOULD NOT]。
    - [ ] 登録サーバーからの200(OK)応答は、現在のすべてのバインディングを列挙するContactフィールドのリストを含む。そのUAが生成したものであれば、expiresパラメータまたは(それがなければ)Expiresフィールド値に従って、有効期限時間間隔をアップデートする。UAはそれから、それの各バインディングに対して、有効期限間隔が経過する前に、REGISTERリクエストを発行する。
      - 更新間隔(Expires)の半分の時間で、REGISTERリクエストを発行しリフレッシュする。
      - サーバが認めた更新時間を反映する。(TODO)
    - ~~UAは、いくつかのアップデートを一つのREGISTERリクエストにまとめてもよい[MAY]。~~
      - 複数のバインディングに対応しない。
    - [x] UAは、一つのブートサイクルのあいだ、すべての登録に対して同一のCall-IDを使用するべきである[SHOULD]。
      - 10.2のCall-IDと重複した。
    - [ ] 登録のリフレッシュは、リダイレクトしたのでなければ、オリジナルの登録と同じネットワークアドレスに送られるべきである[SHOULD]。
  - 10.2.5 内部クロックの設定
    - ~~REGISTERリクエストへの応答がDateヘッダーフィールドを含む場合、クライアントは何らかの内部クロックを設定するための現在時間を知るために、このヘッダーフィールドを使用してもよい[MAY]。~~
      - 使用しない。
  - 10.2.6 登録サーバーの発見
    - UAは登録を送るアドレスを決定するために3つの方法を使用できる。
      - あらかじめ設定することによって、
      - Address-of-Recordを使用することによって、
        - ~~設定済みの登録サーバーアドレスがない場合、UAはRequest-URIとしてAddress-of-Recordのホスト部分を使い、通常のSIPサーバーの位置特定の仕組みを使用して、リクエストをそこに送るべきである[SHOULD]。~~
          - レジストラの設定を必須とする。
      - およびマルチキャストによってである。
        - ~~マルチキャストによる登録は、「すべてのSIPサーバー」のwell-knownマルチキャストアドレスであるsip.mcast.net(IPv4では224.0.1.75)に宛てて送られる。SIP UAはそのアドレスをリッスンして他のローカルユーザーの場所を認識するために使用してもよい[MAY]。~~
          - レジストラの設定を必須とする。
      - この仕様の適用範囲外の方法で、UAに登録サーバーのアドレスを設定することができる。
  - 10.2.7 リクエストの送信
    - [ ] REGISTERに対する応答が得られなかったためにトランザクションレイヤーがタイムアウトエラーを返す場合、UACは同じ登録サーバーにすぐに再試行するべきではない[SHOULD NOT]。特定の時間間隔は指示されていない。
  - 10.2.8 エラー応答
    - [ ] UAが423(Interval Too Brief)応答を受け取る場合、UAは、REGISTERリクエストのすべてのコンタクトアドレスの有効期限間隔を423(Interval Too Brief)応答のMin-Expiresヘッダーフィールドの有効期限間隔以上にした後で、登録を再試行してもよい[MAY]。
- 10.3 REGISTERリクエスト処理
  - 原則、クライアントでは考慮しない。一部、補足に抽出する。
- 補足
  - [x] 登録サーバーは423(IntervalToo Brief)応答で登録を拒否する可能性がある。[Page 64]
    - 10.2.8と重複した。
